<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tech-PE Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600;700&family=Roboto:wght@400;500;700&family=Merriweather:wght@400;700&family=Caveat&family=Patrick+Hand&family=Ubuntu:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
body {
  margin: 0;
  font-family: 'Patrick Hand', cursive;  /* ✅ Default font changed */
  background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
  display: flex;
  justify-content: center;
  padding: 40px 20px;
  color: #111;
}
.container { max-width: 1200px; width: 100%; }
h1 { text-align: center; font-size: 2.2rem; font-weight: 700; margin-bottom: 30px; color: #fff; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); }
.card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); margin-bottom: 30px; transition: transform 0.3s; display: flex; flex-direction: column; }
.card:hover { transform: translateY(-5px); }
.input-group, .template-select { display: flex; flex-direction: column; margin-bottom: 20px; }
label { font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
input, select { padding: 10px; border-radius: 12px; border: 1px solid #ccc; font-size: 0.9rem; transition: all 0.3s; font-family: 'Patrick Hand', cursive; } /* ✅ ensure inputs inherit default font */
input:focus, select:focus { border-color: #4f46e5; box-shadow: 0 0 8px rgba(79,70,229,0.3); outline: none; }
.buttons { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; justify-content: flex-start; }
button { padding: 10px 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; background: #4f46e5; color: #fff; transition: all 0.3s; font-size: 0.9rem; }
button:hover { background: #3730a3; transform: translateY(-2px); }
.summary-cards { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
.summary-card { flex: 1; min-width: 150px; background: #ffffffaa; backdrop-filter: blur(8px); padding: 20px; border-radius: 16px; text-align: center; font-weight: 600; font-size: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: transform 0.3s; }
.summary-card:hover { transform: translateY(-5px); }
.table-container { width: 100%; border-radius: 16px; border: 1px solid #ccc; overflow: hidden; margin-bottom: 20px; }
table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; table-layout: fixed; font-size: 0.85rem; font-family: 'Patrick Hand', cursive; } /* ✅ table font */
th, td { text-align: center; padding: 10px; border-bottom: 1px solid #ddd; border-radius: 0; }
td { background: #fff; border-radius: 8px; margin: 2px; transition: background 0.3s; }
td input { background: transparent; border: none; width: 100%; font-size: 0.85rem; text-align: center; padding: 4px 0; font-family: 'Patrick Hand', cursive; } /* ✅ input font */
canvas { margin-top: 30px; background: #ffffffaa; border-radius: 20px; padding: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
@media(max-width:768px){
  table, th, td { font-size: 0.75rem; padding: 6px; }
  input, select { font-size: 0.75rem; padding: 6px; }
  button { font-size: 0.75rem; padding: 8px 12px; }
}

/* Table Themes */
.table-theme-1 th { background:#1E3A8A; color:#fff; } .table-theme-1 td { background:#DBEAFE; }
.table-theme-2 th { background:#F97316; color:#fff; } .table-theme-2 td { background:#FFF7ED; }
.table-theme-3 th { background:#059669; color:#fff; } .table-theme-3 td { background:#D1FAE5; }
.table-theme-4 th { background:#DC2626; color:#fff; } .table-theme-4 td { background:#FEE2E2; }
.table-theme-5 th { background:#0EA5E9; color:#fff; } .table-theme-5 td { background:#E0F2FE; }  /* ✅ Sky Blue */
.table-theme-6 th { background:#7C3AED; color:#fff; } .table-theme-6 td { background:#EDE9FE; }
.table-theme-7 th { background:#EC4899; color:#fff; } .table-theme-7 td { background:#FCE7F3; }
.table-theme-8 th { background:#F59E0B; color:#fff; } .table-theme-8 td { background:#FFFAEB; }
.table-theme-9 th { background:#22C55E; color:#fff; } .table-theme-9 td { background:#D9F99D; }
.table-theme-10 th { background:#14B8A6; color:#fff; } .table-theme-10 td { background:#D1FAFA; }

/* Editable header styling for Station Name */
#stationTable th:first-child {
  font-weight: 600;
  font-size: 0.80rem;
  cursor: text;
  white-space: normal;
  line-height: 1.2;
}
</style>
</head>
<body>
<div class="container">
<h1>TECH-PE Dashboard</h1>

<div class="card">

<div class="input-group">
<label for="lineName">Line Name</label>
<input type="text" id="lineName" placeholder="Eg., Preburn | Postburn | Final Stage">
</div>

<div class="template-select">
<label for="shiftSelect">Select Shift:</label>
<select id="shiftSelect" onchange="updateDateShift()">
  <option value="A">A</option>
  <option value="B">B</option>
  <option value="C">C</option>
</select>
</div>

<div class="template-select">
<label for="fontSelect">Select Font:</label>
<select id="fontSelect" onchange="changeFont(this.value)">
<option value='Poppins, sans-serif'>Poppins</option>
<option value='Inter, sans-serif'>Inter</option>
<option value='Roboto, sans-serif'>Roboto</option>
<option value='Merriweather, serif'>Merriweather</option>
<option value='Caveat, cursive'>Caveat</option>
<option value='Patrick Hand, cursive' selected>Patrick Hand</option> <!-- ✅ Default -->
<option value='Ubuntu, sans-serif'>Ubuntu</option>
<option value='Lato, sans-serif'>Lato</option>
<option value='Montserrat, sans-serif'>Montserrat</option>
<option value='Oswald, sans-serif'>Oswald</option>
</select>
</div>

<div class="template-select">
<label for="themeSelect">Select Table Theme:</label>
<select id="themeSelect" onchange="changeTableTheme(this.value)">
<option value='0'>Default</option>
<option value='1'>Royal Blue</option>
<option value='2'>Sunny Orange</option>
<option value='3'>Emerald Green</option>
<option value='4'>Crimson Red</option>
<option value='5' selected>Sky Blue</option> <!-- ✅ Preselected -->
<option value='6'>Purple Haze</option>
<option value='7'>Pink Blossom</option>
<option value='8'>Tangerine</option>
<option value='9'>Mint Leaf</option>
<option value='10'>Teal Wave</option>
</select>
</div>

<div class="summary-cards">
  <div class="summary-card" id="avgRetest">Average Retest %: 0%</div>
  <div class="summary-card" id="totalYield">Total Yield: 100%</div>
</div>

<div class="buttons">
  <button onclick="deleteLastRow()">Delete Last Row</button>
  <button onclick="deleteAABColumn()">Delete AAB Column</button>
  <button onclick="clearTable()">Clear Table</button>
  <button onclick="addStation()">Add Station</button>
  <button onclick="plotGraph()">Plot Graph</button>
  <button onclick="downloadTableAsImage()">Download JPG</button>
</div>

<div class="table-container">
<h2 id="lineIdTitle" style="text-align:center; margin-bottom:10px; color:#111;">
  <span id="lineIdText" style="font-weight:700; font-size:1.2rem;">Line</span><br>
  <span id="currentDateShift" style="font-weight:400; font-size:0.9rem;"></span>
</h2>

<table id="stationTable" class="table-theme-5"> <!-- ✅ Sky Blue theme applied -->
<thead>
<tr>
<th contenteditable="true">Station<br>Name</th>
<th>Input</th>
<th>Retest</th>
<th>AAB</th>
<th>Retest %</th>
</tr>
</thead>
<tbody>
<script>
for(let i=1;i<=4;i++){
  document.write(`<tr>
  <td><input type='text' placeholder='Station ${i}'></td>
  <td><input type='number' oninput='updateRetestPercent(this)'></td>
  <td><input type='number' oninput='updateRetestPercent(this)'></td>
  <td><input type='number'></td>
  <td><span class='rr'>0%</span></td>
  </tr>`);
}
</script>
</tbody>
</table>
</div>

<canvas id="graphCanvas"></canvas>
</div>
</div>

<script>
const table = document.getElementById('stationTable');
const chartCanvas = document.getElementById('graphCanvas');
let chartInstance = null;

// Font change
function changeFont(font){
  document.body.style.fontFamily = font;
  document.querySelectorAll('input').forEach(i=>i.style.fontFamily = font);
  document.getElementById('lineIdTitle').style.fontFamily = font;
}

// Table theme change
function changeTableTheme(themeNumber){
  table.className=''; // reset
  if(themeNumber!=='0') table.classList.add(`table-theme-${themeNumber}`);
}

// Retest %
function updateRetestPercent(el){
  const row = el.closest('tr');
  const inputs = row.querySelectorAll('input');
  const inputVal = parseFloat(inputs[1]?.value)||0;
  const retestVal = parseFloat(inputs[2]?.value)||0;
  const rrSpan = row.querySelector('.rr');
  if(inputVal>0){
    rrSpan.innerText = ((retestVal/inputVal)*100).toFixed(2)+'%';
    if(retestVal>inputVal) inputs[2].style.border='2px solid red';
    else inputs[2].style.border='none';
  } else rrSpan.innerText='0%';
  updateSummary();
}

function updateSummary(){
  const rows = table.querySelectorAll('tbody tr');
  let totalInput=0, totalRetest=0;
  rows.forEach(r=>{
    const inputs=r.querySelectorAll('input');
    totalInput += parseFloat(inputs[1]?.value)||0;
    totalRetest += parseFloat(inputs[2]?.value)||0;
  });
  const avgRetestPercent = totalInput > 0 ? Math.min((totalRetest/totalInput*100),100).toFixed(2) : 0;
  document.getElementById('avgRetest').innerText = 'Average Retest %: ' + avgRetestPercent + '%';
  document.getElementById('totalYield').innerText = 'Total Yield: ' + (100 - avgRetestPercent) + '%';
}

function clearTable(){
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(r=>{
    r.querySelectorAll('input').forEach(i=>i.value='');
    r.querySelector('.rr').innerText='0%';
    r.querySelectorAll('input')[2].style.border='none';
  });
  updateSummary();
}

function addStation(){
  const tbody = table.querySelector('tbody');
  const row = tbody.insertRow();
  row.innerHTML = `<td><input type='text' placeholder='Station'></td>
  <td><input type='number' oninput='updateRetestPercent(this)'></td>
  <td><input type='number' oninput='updateRetestPercent(this)'></td>
  <td><input type='number'></td>
  <td><span class='rr'>0%</span></td>`;
  updateSummary();
}

function deleteLastRow(){
  const tbody = table.querySelectorAll('tbody tr');
  if(tbody.length>0) tbody[tbody.length-1].remove();
  updateSummary();
}

function deleteAABColumn(){
  const rows = table.querySelectorAll('tr');
  rows.forEach(row => { if(row.cells.length >=4) row.deleteCell(3); });
}

function downloadTableAsImage(){
  const tableContainer = document.querySelector('.table-container');
  const chartCanvas = document.getElementById('graphCanvas');

  const tempDiv = document.createElement('div');
  tempDiv.style.background = "#fff";
  tempDiv.style.padding = "20px";
  tempDiv.style.display = "inline-block";

  tempDiv.appendChild(tableContainer.cloneNode(true));
  tempDiv.appendChild(chartCanvas);

  document.body.appendChild(tempDiv);

  html2canvas(tempDiv, {scale:3, useCORS:true}).then(canvas=>{
    const link = document.createElement('a');
    link.download = 'TECH-PE_dashboard.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    document.body.removeChild(tempDiv);
  }).catch(err=>{
    console.error("html2canvas error:", err);
    document.body.removeChild(tempDiv);
  });
}

function plotGraph(){
  const rows = table.querySelectorAll('tbody tr');
  const labels=[], inputData=[], retestData=[], aabData=[], rrData=[];
  rows.forEach(row=>{
    const inputs=row.querySelectorAll('input');
    const station = inputs[0].value.trim();
    const input=parseFloat(inputs[1]?.value)||0;
    const retest=parseFloat(inputs[2]?.value)||0;
    const aab=parseFloat(inputs[3]?.value)||0;
    if(!station) return;
    labels.push(station);
    inputData.push(input);
    retestData.push(retest);
    aabData.push(aab);
    rrData.push(input>0?((retest/input)*100).toFixed(2):0);
  });
  if(labels.length===0) return alert("Enter station data to plot graph.");
  const ctx = chartCanvas.getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{
      labels,
      datasets:[
        { label:'Input', data:inputData, backgroundColor:'#3b82f6', yAxisID:'y' },
        { label:'Retest', data:retestData, backgroundColor:'#f59e0b', yAxisID:'y1' },
        { label:'AAB', data:aabData, backgroundColor:'#10b981', yAxisID:'y' }
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{ position:'top' },
        tooltip:{
          callbacks:{
            afterBody:function(context){ const index=context[0].dataIndex; return `Retest %: ${rrData[index]}%`; }
          }
        }
      },
      scales:{
        y:{ beginAtZero:true, position:'left', title:{ display:true, text:'Input/AAB Count' } },
        y1:{ beginAtZero:true, position:'right', title:{ display:true, text:'Retest Count' }, grid:{ drawOnChartArea:false } },
        x:{ grid:{ display:false } }
      },
      indexAxis:'x'
    }
  });
}

// ✅ FIXED FUNCTION
function updateDateShift() {
    const shift = document.getElementById("shiftSelect").value;
    const lineName = document.getElementById("lineName").value || "-"; // default if empty
    let date = new Date();

    // If shift is C, subtract one day
    if (shift === "C") {
        date.setDate(date.getDate() - 1);
    }

    // Format date as DD/MM/YYYY
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const formattedDate = `${day}/${month}/${year}`;

    // Update line id and date-shift
    document.getElementById("lineIdText").innerText = ` ${lineName}`;
    document.getElementById("currentDateShift").innerText = `${formattedDate} | Shift: ${shift}`;
}


// Init
document.addEventListener("DOMContentLoaded", () => {
  updateDateShift();
  document.getElementById("shiftSelect").addEventListener("change", updateDateShift);
  document.getElementById("lineName").addEventListener("input", updateDateShift);
});
</script>
</body>
</html>
